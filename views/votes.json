{
   "_id": "_design/votes",
   "_rev": "5-a98cb7c2d709014771463632444e8a2f",
   "language": "javascript",
   "views": {
       "sumVotesByPoll": {
           "map": "function(doc) {\n  var hashId = 'twote', userId, tweetId, hashTag, hashTags;\n  userId = doc.user.id;\n  tweetId = doc.id_str;\n  hashTags = [];\n\n  // Iterate trough hashtags\n  for (var i in doc.entities.hashtags) {\n    hashTag = doc.entities.hashtags[i].text.toLowerCase();\n    // Filter out our own hashId\n    if (hashTag === hashId) continue;\n    // Filter double hashtags\n    if(hashTags.indexOf(hashTag) > -1) continue;\n    // Emit hashtag\n    hashTags.push(hashTag);\n  }\n\n  var j = hashTags.length - (hashTags.length - 1), res;\n  for (j; j < hashTags.length; j++) {\n    res = {votes: {}, snapshot: {}};\n    res.votes[hashTags[j]] = {};\n    res.votes[hashTags[j]][userId] = tweetId;\n    res.snapshot[userId] = tweetId;\n    emit(hashTags[0], res);\n  }\n\n}",
           "reduce": "function (keys, values) {\n\n  var i, tag, user, res = {votes: {}, snapshot: {}};\n\n  for (i = 0; i < values.length; i++) {\n\n    // Walk the dataset snapshots, determine up-to-date\n    // snapshot (tweetid) for user.\n    for (user in values[i].snapshot) {\n      if (typeof res.snapshot[user] === 'undefined' ||\n          values[i].snapshot[user] > res.snapshot[user]) {\n        // Our local snapshot of the user is outdated, update.\n        res.snapshot[user] = values[i].snapshot[user];\n      }\n    }\n\n    // Walk all tags in the vote topic, and copy the data\n    // if it is up-to-date.\n    for (tag in values[i].votes) {\n      for (user in values[i].votes[tag]) {\n        if (values[i].votes[tag][user] === res.snapshot[user]) {\n          // The vote data is up-to-date, so copy to local.\n          if (typeof res.votes[tag] === 'undefined') {\n            res.votes[tag] = {};\n          }\n          res.votes[tag][user] = res.snapshot[user];\n        }\n      }\n    }\n\n  }\n\n  // Walk the local vote data and delete all data\n  // that is outdated.\n  for (tag in res.votes) {\n    for (user in res.votes[tag]) {\n      if (res.votes[tag][user] < res.snapshot[user]) {\n        delete res.votes[tag][user];\n      }\n    }\n  }\n\n  return res;\n\n}"
       }
   }
}
